# lock-sample
开发中使用到的锁示例

## 1、乐观锁

乐观锁总是假设最好的情况，认为共享的资源每次被访问的时候不会出现问题，只是在提交修改的时候
去验证对应的资源（也就是数据）是否被其它线程修改了

实现方法有使用版本号机制、CAS 算法

### 版本号机制

版本号机制一般是在数据表中加上一个数据版本号 version 字段，表示数据被修改的次数。当数据被修改时，version 值会加一。当线程 A 要更新数据值时，在读取数据的同时也会读取 version 值，在提交更新时，比较读取到的 version 值与当前数据库中的 version 值是否相等，相等时才更新，否则重试操作。

### CAS算法

CAS的思想就是用一个预期值和要更新的变量值进行比较，两值相等才会进行更新。C#中 **Interlocked** 类

依赖：CPU的原子指令

CAS 涉及到三个操作数：

- V：要更新的变量值(Var)

- E：预期值(Expected)

- N：拟写入的新值(New)

当且仅当 V 的值等于 E 时，CAS 通过原子方式用新值 N 来更新 V 的值。如果不等，说明已经有其它线程更新了 V，则当前线程放弃更新。需要注意ABA问题